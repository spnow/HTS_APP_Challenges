#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

struct license_header
{
  char magic_1[4];              /* LIC\0 */
  char version[4];              /* 1.8\0 */
  char num_1[10];               /* 8char num + \0 */
  char num_2[10];               /* 8char num + \0 */
};


int
keygen (char *dest, char *user)
{
  int offset, len;
  char *len_1 = "1aaaaaaaa";
  char *len_2 = "1bbbbbbbb";
  char *s1 = "----";
  char *s2 = "=";


  len = atoi (len_1);
  if (len < 4)
    len = 4;
  assert (len == strlen (s1));

  len = atoi (len_2);
  if (len > 0x800)
    len = 0x800;
  assert (len == strlen (s2));

  /* 0-3 header */
  strcpy (dest, "LIC");

  /* 4-7 version */
  strcpy (dest + 4, "1.8");

  /* 8-17 */
  strcpy (dest + 8, len_1);

  /* 18-27 */
  strcpy (dest + 18, len_2);

  /* 28-31 footer */
  strcpy (dest + 28, "HTS");

  offset = 0x20;
  /* s1 */
  memcpy (dest + offset, s1, strlen (s1) + 1);
  offset += strlen (s1) + 1;

  /* s2 */
  memcpy (dest + offset, s2, strlen (s2) + 1);
  offset += strlen (s2) + 1;

  /* 50-56 */
  memset (dest + offset, 0, 0x0a);
  offset += 0x0a;

  strcpy (dest + offset, "HTS_NQ");
  offset += strlen ("HTS_NQ") + 1;

  memset (dest + offset, 0, 0x0a);
  offset += 0x0a;

  return offset;
}


int
main (int argc, char **argv)
{
  int fd, key_len;
  char buf[1000];

  if (argc != 3)
    {
      fprintf (stderr, "Usage: %s <user> <key_file>\n", argv[0]);
      exit (-1);
    }

  memset (buf, 0, 1000);

  key_len = keygen (buf, argv[1]);

  fd = open (argv[2], O_RDWR | O_CREAT | O_TRUNC);
  if (fd < 0)
    {
      perror ("Error writing file");
      exit (-1);
    }

  write (fd, buf, key_len);

  close (fd);

  return 0;
}


int
validate (char *s1, char *s2)
{
  int i, count, key;
  char str[12] = "";

  count = 0;
  key = 0;

  for (i = 0; i < 0x32; i++)
    {
      for (j = 0; j < strlen (s1); j++)   /* loc_4017E3 */
        {
          key += -238;
          key |= s1[j];
          key = (key >> i) ^ key;
          key = key * key;
        }

      if (i > 0)                /* loc_401827 */
        {
          itoa (key, str, 10);
            j = 0;
            while (j || str[j] != '0')        /* loc_401863 */
              {
                if (s2[j] != toupper (str[j]))        /* loc_401876 */
                  return;
                j++;
                count++;
                if (j > strlen(str))
                  break;
              }
        }
    }

  if (count == strlen (s2))
    return 0;
  else
    return -1;
}
